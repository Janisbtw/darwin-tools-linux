#!/bin/bash

set -e
shopt -s extglob

info() { echo "[info] $1"; }

ROOT="${PWD}"
STAGING="${ROOT}/staging"
PACKAGES="${ROOT}/packages"
export INSTALLPREFIX="${STAGING}/linux/iphone"
export JOBS=8

info "Creating prefix dir"
rm -rf "${STAGING}"
mkdir -p "${INSTALLPREFIX}"

info "Building libtapi"
cd "${ROOT}/apple-libtapi"
./build.sh
./install.sh
make -C "${ROOT}/apple-libtapi/build" install-tapi -j "${JOBS}"

info "Building cctools"
cd "${ROOT}/cctools-port/cctools"
./configure \
	--prefix="${INSTALLPREFIX}" \
	--with-libtapi="${INSTALLPREFIX}" \
	--target="aarch64-apple-darwin14" \
	--program-prefix="" \
	LDFLAGS="-Wl,-rpath,'\$\$ORIGIN/../lib' -Wl,-z,origin" \
	PROGRAM_PREFIX=""
make -j "${JOBS}" install

info "Installing ldid"
cd "${ROOT}/ldid"
make -j "${JOBS}" DESTDIR="${INSTALLPREFIX}" PREFIX="" install

info "Packaging toolchain"
mkdir -p "${PACKAGES}"
cd "${STAGING}"
tar -czf "${PACKAGES}/darwin-tools.tar.gz" linux

info "Done!"
